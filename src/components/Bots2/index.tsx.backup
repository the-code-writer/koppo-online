import React, { useState, useEffect } from 'react';
import {
  Row,
  Col,
  Card,
  Button,
  Tag,
  Typography,
  Space,
  Flex,
  Empty,
  Spin,
  Tooltip,
  Badge,
  Input,
  message
} from 'antd';
import {
  PlayCircleOutlined,
  PauseCircleOutlined,
  StopOutlined,
  TrophyOutlined,
  ClockCircleOutlined,
  DollarOutlined,
  ThunderboltOutlined,
  PlusOutlined,
  FileSearchOutlined
} from '@ant-design/icons';
import { BotInstance } from '../../types/bot';
import { botAPI } from '../../services/api';
import './styles.scss';
import { useFirebaseGlobal } from '../../contexts/FirebaseGlobalContext';

const { Title, Text } = Typography;

// Mock data for demonstration
const mockBots: BotInstance[] = [
  {
    _id: '1',
    userId: 'user1',
    configuration: {
      general: { botName: 'Alpha Trader', tradeType: 'Rise', market: 'Volatility 100 (1s) Index' },
      basicSettings: { number_of_trades: 50, maximum_stake: 1000, compound_stake: true },
      amounts: {
        amount: { type: 'fixed', value: 10 },
        profit_threshold: { type: 'fixed', value: 100 },
        loss_threshold: { type: 'fixed', value: 50 }
      },
      recovery: { risk_steps: [] },
      schedules: { bot_schedules: [] },
      execution: { recovery_type: 'on', cooldown_period: '300', stop_on_loss_streak: false, auto_restart: true }
    },
    status: 'running',
    sessionId: 'session1',
    createdAt: '2024-01-10T10:00:00Z',
    updatedAt: '2024-01-10T10:00:00Z',
    lastRunAt: '2024-01-10T10:00:00Z',
    totalProfit: 1250.50,
    totalLoss: 320.25,
    totalTrades: 45,
    runningTime: 3600
  },
  {
    _id: '2',
    userId: 'user1',
    configuration: {
      general: { botName: 'Beta Scalper', tradeType: 'Fall', market: 'Volatility 75 (1s) Index' },
      basicSettings: { number_of_trades: 30, maximum_stake: 500, compound_stake: false },
      amounts: {
        amount: { type: 'fixed', value: 5 },
        profit_threshold: { type: 'fixed', value: 50 },
        loss_threshold: { type: 'fixed', value: 25 }
      },
      recovery: { risk_steps: [] },
      schedules: { bot_schedules: [] },
      execution: { recovery_type: 'off', cooldown_period: '0', stop_on_loss_streak: false, auto_restart: false }
    },
    status: 'paused',
    createdAt: '2024-01-09T15:30:00Z',
    updatedAt: '2024-01-09T15:30:00Z',
    lastRunAt: '2024-01-09T15:30:00Z',
    totalProfit: 450.75,
    totalLoss: 180.50,
    totalTrades: 28,
    runningTime: 1800
  },
  {
    _id: '3',
    userId: 'user1',
    configuration: {
      general: { botName: 'Gamma Runner', tradeType: 'Rise', market: 'Boom 1000 Index' },
      basicSettings: { number_of_trades: 100, maximum_stake: 2000, compound_stake: true },
      amounts: {
        amount: { type: 'fixed', value: 25 },
        profit_threshold: { type: 'fixed', value: 200 },
        loss_threshold: { type: 'fixed', value: 100 }
      },
      recovery: { risk_steps: [] },
      schedules: { bot_schedules: [] },
      execution: { recovery_type: 'on', cooldown_period: '600', stop_on_loss_streak: true, auto_restart: true }
    },
    status: 'stopped',
    createdAt: '2024-01-08T12:00:00Z',
    updatedAt: '2024-01-08T12:00:00Z',
    lastRunAt: '2024-01-08T12:00:00Z',
    totalProfit: 890.00,
    totalLoss: 445.00,
    totalTrades: 67,
    runningTime: 0
  }
];

export function Bots2() {
  const [loading, setLoading] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [isHeaderFixed, setIsHeaderFixed] = useState(false);
  const [botsCreated, setBotsCreated] = useState(false);

  const {
  bots,
  createBot
} = useFirebaseGlobal();

useEffect(()=>{

console.log("MY BOTS", bots)


},[bots])

useEffect(()=>{
  // Only create bots once and only if there are no existing bots
  if (botsCreated || bots.length > 0) return;

  // Create 3 static bots with the new schema
  const staticBots = [
    {
      botName: "Volatility Master",
      botDescription: "Advanced bot for trading volatility indices with high precision",
      marketName: "Volatility 100 (1s) Index",
      contractType: "Rise/Fall",
      strategyName: "Momentum Reversal",
      startedAt: new Date(),
      netProfit: 1250.50,
      baseStake: 25.00,
      numberOfWins: 45,
      numberOfLosses: 12,
      state: "PLAY" as const,
      botMetadata: {
        version: "2.1.0",
        algorithm: "neural_network",
        riskLevel: "medium"
      },
      isActive: true,
      totalTrades: 57,
      winRate: 78.9,
      averageProfit: 21.93,
      maxDrawdown: 150.00,
      lastRunAt: new Date(),
      settings: {
        maxConcurrentTrades: 3,
        stopLoss: 15,
        takeProfit: 30,
        riskPerTrade: 5
      },
      performance: {
        dailyProfit: 85.20,
        weeklyProfit: 425.00,
        monthlyProfit: 1250.50,
        allTimeHigh: 1450.00,
        allTimeLow: -200.00
      },
      params: [
        { key: "repeat_trade", label: "Repeat trade", value: 10 },
        { key: "initial_stake", label: "Initial stake", value: 25 },
        { key: "risk_level", label: "Risk level", value: 5 }
      ]
    },
    {
      botName: "Forex Scalper Pro",
      botDescription: "High-frequency forex trading bot for quick profits",
      marketName: "EUR/USD",
      contractType: "Higher/Lower",
      strategyName: "Scalping Strategy",
      startedAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 days ago
      netProfit: 890.25,
      baseStake: 15.00,
      numberOfWins: 38,
      numberOfLosses: 18,
      state: "PAUSE" as const,
      botMetadata: {
        version: "1.8.5",
        algorithm: "technical_analysis",
        riskLevel: "low"
      },
      isActive: true,
      totalTrades: 56,
      winRate: 67.9,
      averageProfit: 15.90,
      maxDrawdown: 95.00,
      lastRunAt: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
      settings: {
        maxConcurrentTrades: 2,
        stopLoss: 10,
        takeProfit: 20,
        riskPerTrade: 3
      },
      performance: {
        dailyProfit: 45.50,
        weeklyProfit: 320.00,
        monthlyProfit: 890.25,
        allTimeHigh: 950.00,
        allTimeLow: -120.00
      },
      params: [
        { key: "repeat_trade", label: "Repeat trade", value: 15 },
        { key: "initial_stake", label: "Initial stake", value: 15 },
        { key: "timeframe", label: "Timeframe", value: 1 }
      ]
    },
    {
      botName: "Crypto Hunter",
      botDescription: "Cryptocurrency trading bot optimized for BTC and ETH pairs",
      marketName: "BTC/USD",
      contractType: "Touch/No Touch",
      strategyName: "Breakout Hunter",
      startedAt: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000), // 14 days ago
      netProfit: 2340.75,
      baseStake: 50.00,
      numberOfWins: 62,
      numberOfLosses: 23,
      state: "PLAY" as const,
      botMetadata: {
        version: "3.0.1",
        algorithm: "sentiment_analysis",
        riskLevel: "high"
      },
      isActive: true,
      totalTrades: 85,
      winRate: 72.9,
      averageProfit: 27.54,
      maxDrawdown: 280.00,
      lastRunAt: new Date(Date.now() - 30 * 60 * 1000), // 30 minutes ago
      settings: {
        maxConcurrentTrades: 5,
        stopLoss: 20,
        takeProfit: 40,
        riskPerTrade: 8
      },
      performance: {
        dailyProfit: 125.30,
        weeklyProfit: 875.00,
        monthlyProfit: 2340.75,
        allTimeHigh: 2500.00,
        allTimeLow: -350.00
      },
      params: [
        { key: "repeat_trade", label: "Repeat trade", value: 20 },
        { key: "initial_stake", label: "Initial stake", value: 50 },
        { key: "leverage", label: "Leverage", value: 10 }
      ]
    }
  ];

  // Create each bot
  const createBots = async () => {
    try {
      for (let i = 0; i < staticBots.length; i++) {
        const botData = staticBots[i];
        await createBot(botData);
        console.log(`Static bot ${i + 1} created:`, botData.botName);
      }
      // Mark bots as created to prevent re-creation
      setTimeout(() => setBotsCreated(true), 0);
    } catch (error) {
      console.error('Error creating static bots:', error);
      setTimeout(() => setBotsCreated(true), 0);
    }
  };

  createBots();

},[createBot, botsCreated])

  // Handle scroll events for header positioning
  useEffect(() => {
    const handleScroll = () => {
      const scrollY = window.scrollY;
      if (scrollY > 57) {
        setIsHeaderFixed(true);
      } else {
        setIsHeaderFixed(false);
      }
    };

    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  // Filter bots based on search query
  const filteredBots = bots.filter(bot => 
    bot.botName.toLowerCase().includes(searchQuery.toLowerCase()) ||
    bot.marketName.toLowerCase().includes(searchQuery.toLowerCase()) ||
    bot.strategyName.toLowerCase().includes(searchQuery.toLowerCase()) ||
    bot.contractType.toLowerCase().includes(searchQuery.toLowerCase())
  );

  // Format running time to HH:MM:SS
  const formatTime = (seconds: number): string => {
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  // Calculate net profit
  const getNetProfit = (bot: any): number => {
    return bot.netProfit || 0;
  };

  // Calculate win rate
  const getWinRate = (bot: any): number => {
    if (bot.totalTrades === 0) return 0;
    return Math.round((bot.numberOfWins / bot.totalTrades) * 100);
  };

  // Get status configuration
  const getStatusConfig = (state: string) => {
    switch (state) {
      case 'PLAY':
        return { color: '#52c41a', label: 'Running', icon: <PlayCircleOutlined /> };
      case 'PAUSE':
        return { color: '#faad14', label: 'Paused', icon: <PauseCircleOutlined /> };
      case 'STOP':
        return { color: '#ff4d4f', label: 'Stopped', icon: <StopOutlined /> };
      default:
        return { color: '#d9d9d9', label: 'Unknown', icon: <ClockCircleOutlined /> };
    }
  };

  // Handle bot audit action
  const handleAuditBot = (botId: string) => {
    message.info(`Auditing bot ${botId}`);
    // TODO: Implement audit functionality
  };

  // Handle bot control actions
  const handleBotAction = async (botId: string, action: 'start' | 'pause' | 'stop') => {
    try {
      let response;
      switch (action) {
        case 'start':
          response = await botAPI.startBot(botId);
          break;
        case 'pause':
          response = await botAPI.pauseBot(botId);
          break;
        case 'stop':
          response = await botAPI.stopBot(botId);
          break;
      }

      if (response.success) {
        message.success(`Bot ${action}ed successfully`);
        // Update local state
        setBots(prev => prev.map(bot => 
          bot._id === botId ? { ...bot, status: action === 'start' ? 'running' : action === 'pause' ? 'paused' : 'stopped' } : bot
        ));
      } else {
        message.error(response.error || `Failed to ${action} bot`);
      }
    } catch (error) {
      message.error(`Failed to ${action} bot`);
    }
  };

  return (
    <div className="bots2-container">
      {/* Fixed Search Header */}
      <div className={`bots2-search-header ${isHeaderFixed ? 'fixed' : ''}`}>
        <Row justify="space-between" align="middle" gutter={16}>
          <Col xs={24} sm={24} md={12} lg={12} xl={12}>
          <Flex align="center" justify="space-between">
            <h1 style={{fontSize: 32}}>Bots <Badge count={bots.length} /></h1>
            <Space>
              <Button 
                type="primary" 
                icon={<PlusOutlined />} 
                className="create-btn"
              >
                Create Bot
              </Button>
            </Space>
            </Flex>
          </Col>
          <Col xs={24} sm={24} md={12} lg={12} xl={12}>
            <Input
              placeholder="Search bots by name, market, or trade type..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              prefix={<TrophyOutlined />}
              className="search-input"
              allowClear
            />
          </Col>
        </Row>
      </div>

      {/* Main Content */}
      <div className="bots2-main-content">
        {/* Bot List */}
        <div className="bots2-list">
          <Row gutter={[16, 16]}>
            {filteredBots.map((bot) => {
            const statusConfig = getStatusConfig(bot.state);
            const netProfit = getNetProfit(bot);
            const winRate = getWinRate(bot);
            const isProfit = netProfit >= 0;

            return (
              <Col xs={24} sm={24} md={12} lg={12} xl={12} key={bot.id}>
                <Card 
                  className={`bot-card ${bot.state === 'PLAY' ? 'running' : ''}`}
                  hoverable
                  size="small"
                >
                  {/* Card Header */}
                  <div className="bot-card-header">
                    
                      <div className="bot-info"><Flex justify="space-between" align="start">
                        <Title level={5} className="bot-name" style={{ margin: 0 }}>
                          {bot.botName}
                        </Title>
                      <Tag  
                        color={statusConfig.color}
                        className="status-tag"
                      >
                        {statusConfig.icon} {statusConfig.label}
                      </Tag></Flex>
                        <Text type="secondary" className="bot-market">
                          {bot.marketName} • {bot.contractType} • {bot.strategyName || 'Default Strategy'}
                        </Text>
                      </div>
                    
                  </div>

                  {/* Bot Stats */}
                  <div className="bot-stats">
                    <Row gutter={[8, 8]}>
                      <Col span={12}>
                        <div className="stat-item">
                          <Flex align="center" gap={6}>
                            <ClockCircleOutlined className="stat-icon" />
                            <div>
                              <Text type="secondary" className="stat-label">Runtime</Text>
                              <div className="stat-value">{formatTime(bot.runningTime)}</div>
                            </div>
                          </Flex>
                        </div>
                      </Col>
                      <Col span={12}>
                        <div className="stat-item">
                          <Flex align="center" gap={6}>
                            <DollarOutlined className="stat-icon" />
                            <div>
                              <Text type="secondary" className="stat-label">Net Profit</Text>
                              <div className={`stat-value ${isProfit ? 'profit' : 'loss'}`}>
                                {isProfit ? '+' : ''}{netProfit.toFixed(2)}
                              </div>
                            </div>
                          </Flex>
                        </div>
                      </Col>
                      <Col span={12}>
                        <div className="stat-item">
                          <Flex align="center" gap={6}>
                            <ThunderboltOutlined className="stat-icon" />
                            <div>
                              <Text type="secondary" className="stat-label">Base Stake</Text>
                              <div className="stat-value">{bot.baseStake}</div>
                            </div>
                          </Flex>
                        </div>
                      </Col>
                      <Col span={12}>
                        <div className="stat-item">
                          <Flex align="center" gap={6}>
                            <TrophyOutlined className="stat-icon" />
                            <div>
                              <Text type="secondary" className="stat-label">Win Rate</Text>
                              <div className="stat-value">{winRate}%</div>
                            </div>
                          </Flex>
                        </div>
                      </Col>
                    </Row>
                  </div>

                  {/* Controls */}
                  <div className="bot-controls">
                    <div className="control-buttons">
                      <Button
                        className="control-btn audit-btn"
                        onClick={() => handleAuditBot(bot.id)}
                      >
                        <FileSearchOutlined /> Audit
                      </Button>
                      <Tooltip title={bot.state === 'PLAY' ? 'Bot is running' : 'Start Bot'}>
                        <Button
                          className={`control-btn start-btn ${bot.state === 'PLAY' ? 'current-state' : ''}`}
                          onClick={() => handleBotAction(bot.id, 'start')}
                          disabled={bot.state === 'PLAY'}
                        >
                          <PlayCircleOutlined style={{fontSize: 18}} />
                        </Button>
                      </Tooltip>
                      <Tooltip title={bot.state !== 'PLAY' ? 'Bot is not running' : 'Pause Bot'}>
                        <Button
                          className={`control-btn pause-btn ${bot.state === 'PAUSE' ? 'current-state' : ''}`}
                          onClick={() => handleBotAction(bot.id, 'pause')}
                          disabled={bot.state !== 'PLAY'}
                        >
                          <PauseCircleOutlined style={{fontSize: 18}} />
                        </Button>
                      </Tooltip>
                      <Tooltip title={bot.state === 'STOP' ? 'Bot is already stopped' : 'Stop Bot'}>
                        <Button
                          className={`control-btn stop-btn ${bot.state === 'STOP' ? 'current-state' : ''}`}
                          onClick={() => handleBotAction(bot.id, 'stop')}
                          disabled={bot.state === 'STOP'}
                        >
                          <StopOutlined style={{fontSize: 18}} />
                        </Button>
                      </Tooltip>
                    </div>
                  </div>
                </Card>
              </Col>
            );
          })}
        </Row>
      </div>

      {/* Empty State */}
      {filteredBots.length === 0 && !loading && (
        <div className="empty-state">
          <Empty
            description={
              <span className="empty-text">
                {searchQuery ? 'No bots found matching your search.' : 'No bots yet. Create your first trading bot!'}
              </span>
            }
          />
          <Button 
            type="primary" 
            icon={<PlusOutlined />} 
            size="large"
            className="create-first-btn"
          >
            Create Your First Bot
          </Button>
        </div>
      )}

      {/* Loading State */}
      {loading && (
        <div className="loading-state">
          <Spin size="large" />
          <Text type="secondary">Loading your bots...</Text>
        </div>
      )}
      </div>
    </div>
  );
}
